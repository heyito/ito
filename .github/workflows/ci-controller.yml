name: CI Controller

on:
  push:
    branches:
      - 'main'
      - 'dev'
  pull_request:
    branches:
      - '**'

jobs:
  run-tests:
    uses: ./.github/workflows/test-runner.yml

  native-build-check:
    uses: ./.github/workflows/native-build-check.yml

  # This job ONLY runs for pushes to 'dev' and 'main'
  deploy-server:
    needs: run-tests
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'dev')
    uses: ./.github/workflows/deploy-server.yml
    with:
      # Dynamically set the environment based on the branch
      environment: ${{ github.ref_name == 'main' && 'production' || 'develop' }}
    secrets: inherit
